
# -----------------
# ----- PARAMS ----
# -----------------
# uint NUM_VOLUMES
# uint SLICE_WIDTH
# uint SLICE_HEIGHT
# uint BYTES_PER_PIXEL
# uint MAX_CUTOFF

# -----------------
# ---- FEATURES ---
# -----------------

enable_feature: perspective_camera

# -----------------
# ---- CONSTS -----
# -----------------

# TODO - support exponentiation, bitshifts, etc in flr expression parser...

uint NUM_LEVELS: 4

uint BR_FACTOR_LOG2: 3
uint BR_FACTOR: 8

uint L3_BLOCKS_DIM_X: 1
uint L3_BLOCKS_DIM_Y: 1
uint L3_BLOCKS_DIM_Z: 2

uint L2_BLOCKS_DIM_X: L3_BLOCKS_DIM_X*BR_FACTOR
uint L2_BLOCKS_DIM_Y: L3_BLOCKS_DIM_Y*BR_FACTOR
uint L2_BLOCKS_DIM_Z: L3_BLOCKS_DIM_Z*BR_FACTOR

uint L1_BLOCKS_DIM_X: L2_BLOCKS_DIM_X*BR_FACTOR
uint L1_BLOCKS_DIM_Y: L2_BLOCKS_DIM_Y*BR_FACTOR
uint L1_BLOCKS_DIM_Z: L2_BLOCKS_DIM_Z*BR_FACTOR

uint L0_BLOCKS_DIM_X: L1_BLOCKS_DIM_X*BR_FACTOR
uint L0_BLOCKS_DIM_Y: L1_BLOCKS_DIM_Y*BR_FACTOR
uint L0_BLOCKS_DIM_Z: L1_BLOCKS_DIM_Z*BR_FACTOR

uint L3_NUM_BLOCKS: L3_BLOCKS_DIM_X*L3_BLOCKS_DIM_Y*L3_BLOCKS_DIM_Z
uint L2_NUM_BLOCKS: L2_BLOCKS_DIM_X*L2_BLOCKS_DIM_Y*L2_BLOCKS_DIM_Z
uint L1_NUM_BLOCKS: L1_BLOCKS_DIM_X*L1_BLOCKS_DIM_Y*L1_BLOCKS_DIM_Z
uint L0_NUM_BLOCKS: L0_BLOCKS_DIM_X*L0_BLOCKS_DIM_Y*L0_BLOCKS_DIM_Z

uint TOTAL_NUM_BLOCKS: L3_NUM_BLOCKS+L2_NUM_BLOCKS+L1_NUM_BLOCKS+L0_NUM_BLOCKS

uint CELLS_WIDTH: L0_BLOCKS_DIM_X*8
uint CELLS_HEIGHT: L0_BLOCKS_DIM_Y*8
uint CELLS_DEPTH: L0_BLOCKS_DIM_Z*8

uint DEFAULT_CUTOFF_LO: MAX_CUTOFF/3

# -----------------
# ------ UI -------
# -----------------

checkbox ACCUMULATE: false
slider_float DENSITY: 0.3 0.01 5.0
slider_float G: 0.31 -1.0 1.0
ui_separator
slider_uint CUTOFF_LO: DEFAULT_CUTOFF_LO 0 MAX_CUTOFF
slider_uint CUTOFF_HI: MAX_CUTOFF 0 MAX_CUTOFF
ui_separator
ui_dropdown_start CROSS_SECTION
  slider_uint X_LO: 0 0 CELLS_WIDTH
  slider_uint X_HI: CELLS_WIDTH 0 CELLS_WIDTH
  slider_uint Y_LO: 0 0 CELLS_HEIGHT
  slider_uint Y_HI: CELLS_HEIGHT 0 CELLS_HEIGHT
  slider_uint Z_LO: 0 0 CELLS_DEPTH
  slider_uint Z_HI: CELLS_DEPTH 0 CELLS_DEPTH
ui_dropdown_end
ui_separator
ui_dropdown_start SAMPLING
  slider_uint ITERS: 350 20 1000
  slider_uint LIGHT_ITERS: 8 4 100
  slider_float LIGHT_DT: 2.2 0.001 10.0
  checkbox ENABLE_DOF: true
  slider_float DOF_RAD: 0.61 0.0 1.0
  slider_float DOF_DIST: 0.18 0.001 0.25
ui_dropdown_end

ui_dropdown_start LIGHTS
  slider_float FAKE_AO: 1.2 0.0 2.0
  slider_float LIGHT_INTENSITY: 28.0 1.0 100.0
  slider_float LIGHT_THETA: 5.6 0.0 8.0
  slider_float LIGHT_PHI: 1.0 -2.0 2.0
ui_dropdown_end:

ui_dropdown_start HDDA
  checkbox STEP_UP: true
  checkbox STEP_DOWN: true
  slider_uint DDA_LEVEL: 3 0 3
ui_dropdown_end

ui_dropdown_start SCENE
  slider_uint BACKGROUND: 0 0 2
  slider_float SCENE_SCALE: 0.01 0.001 0.1
  slider_uint VOLUME_IDX: 0 0 NUM_VOLUMES
ui_dropdown_end

ui_dropdown_start MISC
  slider_float EXPOSURE: 0.085 0.01 1.0
  slider_uint RENDER_MODE: 1 0 1

  ui_dropdown_start MISC_LODS
    checkbox LOD_CUTOFFS: false
    checkbox LOD_JITTER: false
    slider_float LOD_SCALE: 1.0 0.1 2.0
  ui_dropdown_end
  
  slider_float CLASSIC_RAYMARCH_DT: 0.1 0.001 0.1
ui_dropdown_end

checkbox ENABLE_STAGGERED_STREAMING: true

# -----------------------------
# ---- STRUCTS / RESOURCES ----
# -----------------------------

# 4x4x4=64 bytes
# 8x8x8=512 bits
struct Block {
  uvec4 bitfield[4];
}
struct_size: 64

uint VOXEL_SUB_BUFFER_COUNT: 16
uint VOXEL_SUB_BUFFER_SIZE: (TOTAL_NUM_BLOCKS+VOXEL_SUB_BUFFER_COUNT-1)/VOXEL_SUB_BUFFER_COUNT
structured_buffer voxelBuffer(VOXEL_SUB_BUFFER_COUNT): Block VOXEL_SUB_BUFFER_SIZE

struct GlobalState {
  uint accumFrames;
}
struct_size: 4
structured_buffer globalState: GlobalState 1

uint BATCH_SIZE: 8
uint UPLOAD_BATCH_SIZE_BASE32: SLICE_WIDTH * SLICE_HEIGHT * BYTES_PER_PIXEL * BATCH_SIZE / 4
structured_buffer batchUploadBuffer(2): uint UPLOAD_BATCH_SIZE_BASE32
  enable_cpu_access

texture_file EnvironmentMap: "C:/Users/nithi/Documents/Code/Fluorescence/Extern/Althea/Content/HDRI_Skybox/NeoclassicalInterior.hdr" hdr

image RayMarchImage: SCREEN_WIDTH SCREEN_HEIGHT rgba32f
  texture_alias RayMarchTexture

display_image DisplayImage

struct VertexOutput {
  vec2 uv;
}
struct_size: 8

# -----------------
# ---- SHADERS ----
# -----------------

compute_shader CS_UploadVoxels: 8 8 1
compute_shader CS_ClearBlocks: 32 1 1

compute_shader CS_Update: 1 1 1
compute_shader CS_RayMarch: 8 8 1

# -----------------
# --- RENDERING ---
# -----------------

barrier: globalState
compute_dispatch: CS_Update 1 1 1
barrier: globalState

transition_layout: RayMarchImage image
compute_dispatch: CS_RayMarch SCREEN_WIDTH SCREEN_HEIGHT 1
transition_layout: RayMarchImage texture

render_pass DISPLAY_PASS:
  store_attachments: outDisplay=DisplayImage

  draw: VS_RayMarchVoxels PS_RayMarchVoxels 3 1
    vertex_output: VertexOutput
    disable_depth
